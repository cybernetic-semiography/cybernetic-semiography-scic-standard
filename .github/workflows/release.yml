name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
    
    - name: Update VERSION file
      run: echo "${{ steps.get_version.outputs.VERSION }}" > VERSION
    
    - name: Generate changelog
      id: changelog
      run: |
        # Simple changelog generation from git log
        echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
        git log $(git describe --tags --abbrev=0 HEAD^)..HEAD --pretty=format:"- %s (%h)" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: Create release archive
      run: |
        mkdir -p release
        tar -czf release/neosigm-genesis-${{ steps.get_version.outputs.VERSION }}.tar.gz \
          --exclude='.git' \
          --exclude='venv' \
          --exclude='__pycache__' \
          --exclude='*.pyc' \
          --exclude='.github' \
          .
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        name: NeoSigm Genesis v${{ steps.get_version.outputs.VERSION }}
        body: |
          ## What's Changed
          
          ${{ steps.changelog.outputs.CHANGELOG }}
          
          ## Installation
          
          ```bash
          wget https://github.com/cybernetic-semiography/cybernetic-semiography-scic-standard/releases/download/v${{ steps.get_version.outputs.VERSION }}/neosigm-genesis-${{ steps.get_version.outputs.VERSION }}.tar.gz
          tar -xzf neosigm-genesis-${{ steps.get_version.outputs.VERSION }}.tar.gz
          cd cybernetic-semiography-scic-standard
          pip install -r requirements.txt
          ```
          
          ## Documentation
          
          See [README.md](https://github.com/cybernetic-semiography/cybernetic-semiography-scic-standard/blob/v${{ steps.get_version.outputs.VERSION }}/README.md) for usage instructions.
        files: |
          release/neosigm-genesis-${{ steps.get_version.outputs.VERSION }}.tar.gz
          VERSION
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Notify success
      run: echo "Release v${{ steps.get_version.outputs.VERSION }} created successfully!"
